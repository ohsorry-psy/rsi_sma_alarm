# autotrade.py
import os
import pandas as pd
from modules.strategy import run_strategy
from modules.telegram_alert import send_telegram_message


def format_trade_results(trades_df):
    if trades_df.empty:
        return "âŒ ê±°ë˜ ë‚´ì—­ ì—†ìŒ"

    messages = []
    total_profit = 0
    for idx, row in trades_df.iterrows():
        buy_date = row['Buy Date'].strftime("%Y-%m-%d") if pd.notna(row['Buy Date']) else '-'
        sell_date = row['Sell Date'].strftime("%Y-%m-%d") if pd.notna(row['Sell Date']) else '-'
        profit = row['Return (%)'] if pd.notna(row['Return (%)']) else 0
        total_profit += profit if isinstance(profit, (int, float)) else 0

        messages.append(f"ğŸ“… {buy_date} â• {sell_date} | ìˆ˜ìµë¥ : {profit:.2f}%")

    avg_profit = total_profit / len(trades_df)
    summary = f"âœ… ì´ ê±°ë˜: {len(trades_df)}íšŒ | í‰ê·  ìˆ˜ìµë¥ : {avg_profit:.2f}%"
    return "\n".join(messages + ["", summary])


def main():
    symbol = "042700.KQ"
    start_date = "2023-01-01"
    end_date = "2025-04-15"

    print("[************ ì „ëµ ì‹¤í–‰ ì‹œì‘ ************]")
    print(f"ğŸŒ {symbol}: {start_date} ~ {end_date}")

    df, trades_df = run_strategy(symbol, start_date, end_date, backtest=True)

    print("\nâœ… ì „ëµ ì²˜ë¦¬ ì™„ë£Œ.\n")
    print(trades_df[['Buy Date', 'Buy Price', 'Sell Date', 'Sell Price', 'Return (%)']])

    if os.getenv("SEND_ALERT", "True") == "True":
        TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
        TELEGRAM_CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
        msg = f"âœ¨ ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ [{symbol}]\n{format_trade_results(trades_df)}"
        send_telegram_message(TELEGRAM_TOKEN, TELEGRAM_CHAT_ID, msg)


if __name__ == '__main__':
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument("--backtest", action="store_true", help="ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì—¬ë¶€")
    args = parser.parse_args()

    if args.backtest:
        main()